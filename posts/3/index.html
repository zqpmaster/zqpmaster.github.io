
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Max Blog</title>
  <meta name="author" content="一切从简">

  
  <meta name="description" content="最近遇到了将ScrollView放在XIB的视图里，用代码设置contentSize后，scrollView不能滑动的问题。费了很大劲之后找到正确的办法，并且发现XIB的一个极为实用的技巧。如果想用XIB设置视图更多的属性。可以使用Identity inspector下的User Defined &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.sheliw.com/posts/3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Max Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="../javascripts/jquery-1.9.1.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-65051838-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Max Blog</a></h1>
  
    <h2>The way to do really big things is to do really small things and grow them bigger</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<ul class="main-navigation">
  <li><a href="/">博客</a></li>
  <li><a href="/blog/archives">所有文章</a></li>
  <li><a href="http://weibo.com/u/1864993670">新浪微博</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/25/ru-he-shi-yong-xibshe-zhi-shi-tu-de-geng-duo-shu-xing/">如何使用XIB设置视图的更多属性</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-10-25T13:37:20+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>1:37 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近遇到了将ScrollView放在XIB的视图里，用代码设置contentSize后，scrollView不能滑动的问题。费了很大劲之后找到正确的办法，并且发现XIB的一个极为实用的技巧。如果想用XIB设置视图更多的属性。可以使用Identity inspector下的User Defined Runtime Attribute.添加一些KeyPath.</p>

<p>1.在XIB里选中视图。</p>

<p>2.切换到Identity inspector, 新建一个新的User Defined Runtime Attribute (点击  + 按钮)。</p>

<p>3.双击Key Path,改为要设置的属性。</p>

<p>4.双击Type，改为要设置的属性的类型.</p>

<p>5.更改Value为要设置的值。</p>

<p>Swift语言貌似可以使用@IBInspectable和@IBDesignable 直接在Storyboard和Xib里添加设置选项</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/25/zheng-fang-jiao-wu-guan-li-xi-tong-ioske-hu-duan/">正方教务管理系统IOS客户端</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-10-25T13:16:47+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>1:16 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近和朋友一起做完了学校的教务系统iOS客户端，这里写一下我遇到的一些问题和心得。</p>

<h3>用到的几个工具</h3>

<ol>
<li>chrome的开发者工具   查看每次HTTP请求命令与参数等。</li>
<li>AFNetworking    ios网络请求开源框架，同样的有ASIHttprequest。选择AFnetworking是因为它更简单，并且现在还在更新维护，ASI好像好久没有更新。</li>
<li>TFhepple    Html分析类库。</li>
</ol>


<p>在做数据层的时候，我先获取正方系统的html源码，然后解析成本地数据。这中间主要遇到了页面编码和模拟登陆两个问题。</p>

<h3>编码</h3>

<p>正方教务系统因为没有对应的JSON或者XML数据接口，所以只能模拟网页的所有行为，获取html 分析html。
正方教务系统用的编码是GB2312 框架获取下来的NSString虽然已经自动解码，但是很不稳定，有时候会得到空字符串，但是获取下来的DATA就没有这个问题，所以就要手动解码将DATA转为NSString。</p>

<pre><code>NSStringEncoding enc = CFStringConvertEncodingToNSStringEncoding(kCFStringEncodingGB_18030_2000);                 
NSData *data=responseObject;
NSString *transStr=[[NSString alloc]initWithData:data encoding:enc];&lt;/code&gt;&lt;/pre&gt;
</code></pre>

<p>光转码也不行，在分析HTML的时候因为网页头部的编码信息也有问题，所以要做手动修改，这样才能被TFhepple正确解
析。</p>

<pre><code> 
 NSString *utf8HtmlStr = [transStr stringByReplacingOccurrencesOfString:@"http-equiv=\"Content-Type\" content=\"text/html; charset=gb2312\">" withString:@"http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">"];
NSData *htmlDataUTF8 = [utf8HtmlStr dataUsingEncoding:NSUTF8StringEncoding];
TFHpple *xpathParser = [[TFHpple alloc]initWithHTMLData:htmlDataUTF8];</code></pre>


<p>
成绩页面修改的方式有所不同</p>

<pre><code>
NSString *utf8HtmlStr = [transStr stringByReplacingOccurrencesOfString:@"content=\"text/html; charset=gb2312\" http-equiv=\"Content-Type\">" withString:@"http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">"];</code></pre>


<p>其他页面要怎么替换具体要看页面头部具体的信息是什么，然后写在 stringByReplacingOccurrencesOfString方法第一个参数部分就可以。</p>

<h3>模拟登陆</h3>

<p>模拟登陆第一步要获取Cookie，这个用 NSURLRequest就能获取到，之后要在每次请求的时候加到 NSMutableURLRequest 里。AFnetworking在每次请求的时候都会建立一个NSURLRequest对象，改这个就可以。代码如下
获取cookie</p>

<pre><code> 
 NSURLRequest *request = [NSURLRequest requestWithURL:[NSURL URLWithString:@"
http://学校的网址/default2.aspx"]];
//  cachePolicy:NSURLRequestReloadIgnoringLocalAndRemoteCacheData
                                            //timeoutInterval:3];
[NSURLConnection sendSynchronousRequest:request returningResponse:nil error:nil];
NSHTTPCookieStorage *cookieJar = [NSHTTPCookieStorage sharedHTTPCookieStorage];
NSArray *cookies =[cookieJar cookies];
_cookieDictionary= [NSHTTPCookie requestHeaderFieldsWithCookies:cookies];
</code></pre>


<p>
获取验证码的时候必须带上cookie,每次post或者get需要带上的是登陆成功后保存下来的cookie。</p>

<pre><code> 
- (AFHTTPRequestOperation *)POST:(NSString *)URLString
                      parameters:(NSDictionary *)parameters
                         success:(void (^)(AFHTTPRequestOperation *operation, id responseObject))success
                         failure:(void (^)(AFHTTPRequestOperation *operation, NSError *error))failure
{
    NSMutableURLRequest *request = [self.requestSerializer requestWithMethod:@"POST" URLString:[[NSURL URLWithString:URLString relativeToURL:self.baseURL] absoluteString] parameters:parameters error:nil];
    if(self.cookieDictionary) {
        [request setHTTPShouldHandleCookies:NO];
        [request setAllHTTPHeaderFields:self.cookieDictionary];
    }
</code></pre>


<p></p>

<p>模拟登陆提交的参数有 用户名,密码，验证码还有一个viewstate，这个viewstate每次都得在登陆前获取验证码图片的时候同时获取 还是通过GET请求得到页面通过html分析工具得到对应的viwestate，具体可以看我的DEMO.然后在提交参数的时候一并提
交。</p>

<pre><code> 
NSDictionary *parameters = @{@"__VIEWSTATE":self.viewState,@"txtUserName"self.xueHao.text,@"TextBox2":self.miMa.text,@"txtSecretCode":self.yanZhengMa.text,@"RadioButtonList1":@"学生",@"Button1":@""};
</code></pre>


<p>
登陆成功之后就可以用cookie随意访问各个页面了。。不过在请求查询成绩页面的时候还要提交一个viewState,这个viewState参数是从登陆成功后的第一个页面获取，Very long。
并且在访问内部所有页面的时候都要在Request Header里加一个refer参数，这个参数跟提交cookie是一样的道理，学校的系统这个东西不提交不行，但是随便提交一个任何人的页面地址居然就可以了。这部分也是加在AFHTTPRequestOperationManager类里实现文件post 和get 方法底下。</p>

<pre><code> 
   if(self.cookieDictionary) {
        NSMutableDictionary *newDictionary=[self.cookieDictionary mutableCopy];
        [newDictionary setValue:@"http://gdjwgl.bjut.edu.cn/xs_main.aspx?xh=11111111" forKey:@"Referer"];
        [request setAllHTTPHeaderFields:newDictionary];   
    }
</code></pre>


<p></p>

<p>demo地址：<a href="https://github.com/zqpmaster/FangZhengJiaoWU">正方教务系统iOS客户端Demo</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/25/ru-he-zai-cocos2d-xyou-xi-li-ji-cheng-iadyan-gao/">如何在Cocos2d-x游戏里集成iAd广告</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-10-25T12:54:03+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:54 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>1) Link binary with iAd.framework<a href="https://developer.apple.com/library/ios/#recipes/xcode_help-project_editor/Articles/AddingaLibrarytoaTarget.html">https://developer.apple.com/library/ios/#recipes/xcode_help-project_editor/Articles/AddingaLibrarytoaTarget.html</a></p>

<pre><code>1. In the project navigator, select your project
2. Select your target
3.  Select the 'Build Phases' tab
4.  Open 'Link Binaries With Libraries' expander    5.  Click the '+' button
6.  Select iAd.framework
</code></pre>

<p>2) Download iAdSuite<a href="https://developer.apple.com/library/ios/#samplecode/iAdSuite/Introduction/Intro.html">https://developer.apple.com/library/ios/#samplecode/iAdSuite/Introduction/Intro.html</a> and copy files BannerViewController.h and BannerViewController.m from ContainerBanner project to your project.</p>

<p>3) Modify AppController.mm, add</p>

<pre><code>&lt;code&gt;&lt;pre&gt;#import "BannerViewController.h"&lt;/code&gt;&lt;/pre&gt;
</code></pre>

<p>and replace</p>

<pre><code>@implementationAppController
</code></pre>

<p>with</p>

<pre><code>@implementationAppController
{
    BannerViewController*_bannerViewController;
}
</code></pre>

<p>and</p>

<pre><code>// Set RootViewController to window
if([[UIDevicecurrentDevice].systemVersionfloatValue]&lt; 6.0)
{
//
 warning: addSubView doesn't work on iOS6
    [window addSubview:viewController.view];
}else
{
//use this method on ios6
    [window setRootViewController:viewController];
}
</code></pre>

<p>with</p>

<pre><code>_bannerViewController=[[BannerViewController alloc]initWithContentViewController:viewController];
window.rootViewController=_bannerViewController;
</code></pre>

<p>4) Modify RootViewController.mm, add</p>

<pre><code>#import"BannerViewController.h"
</code></pre>

<p>and replace
<code><pre>
/<em>
//The designated initializer.  Override if you create the controller programmatically and want to perform customization that is not appropriate for viewDidLoad.
-(id)initWithNibName:(NSString </em>)nibNameOrNil bundle:(NSBundle <em>)nibBundleOrNil {
 if((self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil])) {
//Custom initialization
}
 return self;
}
</em>/
</code></pre>
with
<code><pre>
-(id)initWithNibName:(NSString<em>)nibNameOrNil bundle:(NSBundle</em>)nibBundleOrNil
 {
    if((self=[super initWithNibName:nibNameOrNil bundle:nibBundleOrNil])){
        [[NSNotificationCenter defaultCenter]addObserver:self selector:@selector(willBeginBannerViewActionNotification:)    name:BannerViewActionWillBegin object:nil];
        [[NSNotificationCenter defaultCenter]addObserver:self selector:@selector(didFinishBannerViewActionNotification:)name:BannerViewActionDidFinisho bject:nil];
}
    return self;
}
</code></pre></p>

<p>and add the following methods
<code><pre>
-(void)willBeginBannerViewActionNotification:(NSNotification<em>)notification{
    NSLog(@&ldquo;willBeginBannerViewActionNotification&rdquo;);
}
-(void)didFinishBannerViewActionNotification:(NSNotification</em>)notification
{
    NSLog(@&ldquo;didFinishBannerViewActionNotification&rdquo;);
}
</code></pre></p>

<p>In willBeginBannerViewActionNotification you can pause your game before the banner view triggers an advertising action. In didFinishBannerViewActionNotification you can resume your game when control is returned to it.</p>

<p>BannerViewController changes EAGLView size when banner becomes visible. If you use it like that, cocos2d-x may not detect touch location correctly. Here are the modifications to BannerViewController.m required to display ADBannerView on top of EAGLView.</p>

<p>1) Edit loadView method and put line</p>

<pre><code>[contentView addSubview:_bannerView];
</code></pre>

<p>after</p>

<pre><code>[contentView addSubview:_contentController.view];
</code></pre>

<p>loadView should look like this:
<code><pre>
-(void)loadView
{
    UIView *contentView=[[UIView alloc]initWithFrame[[UIScreen mainScreen]bounds]];
   [self addChildViewController:<em>contentController];
   [contentView addSubview:</em>contentController.view];
   [<em>contentController didMoveToParentViewController:self];
   [contentView addSubview:</em>bannerView];
   self.view=contentView;
}</code></pre>
2) Edit viewDidLayoutSubviews method and replace
<code><pre>
if(<em>bannerView.bannerLoaded)
 {
    contentFrame.size.height-=bannerFrame.size.height;
    bannerFrame.origin.y=contentFrame.size.height;
}else{
   bannerFrame.origin.y=contentFrame.size.height;
}
</code></pre>
with
<code><pre>
if(</em>bannerView.bannerLoaded)
 {
    bannerFrame.origin.y=0;
}else{
    bannerFrame.origin.y= -bannerFrame.size.height;
}
</code></pre>
P.S. Are you sure you want to use iAd? Besides low fill rate, there are some limitations. For instance, Apple’s policy is not to serve iAd advertisements to applications that are designed for children as stated at <a href="https://developer.apple.com/support/ios/iad-network.html.">https://developer.apple.com/support/ios/iad-network.html.</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/4">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/2">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>最新文章</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/01/20/wo-yao-cai-geng-duo-de-chu-ju/">我要采更多的雏菊</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/05/shi-yong-pythonku-elementtreejie-xi-xmlwen-jian/">使用Python库ElementTree解析XML文件</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/12/dai-bu-zou-de-shi-qing-chun/">再见了，北京</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/16/keychain/">Keychain</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/26/valueforkey-vs-objectforkey/">valueForKey: Vs objectForKey:</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/11/ibeacon/">探寻Beacon技术</a>
      </li>
    
  </ul>
</section>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1265.21">
  <style type="text/css">
    p.p2 {margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times}
    p.p3 {margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px &#8216;Songti SC&#8217;}
    span.s1 {font: 12.0px &#8216;Songti SC&#8217;}
  </style>
</head>
<body>
<h1 style="margin: 0.0px 0.0px 14.9px 0.0px; font: 25.0px Times"><b>关于我</b></h1>
<a href="http://weibo.com/u/1864993670">新浪微博</a><br/>
<a href="https://github.com/zqpmaster">GitHub</a>
</body>
</html>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - 一切从简
  <span class="credit">
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'zqpsea';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>









<script>
  $(document).ready(function() {  
  var stickyNavTop = $('nav').offset().top;  
    
  var stickyNav = function(){  
  var scrollTop = $(window).scrollTop();  
         
  if (scrollTop > stickyNavTop) {   
      $('nav').addClass('sticky');  
  } else {  
      $('nav').removeClass('sticky');   
  }  
  };  
    
  stickyNav();  
    
  $(window).scroll(function() {  
      stickyNav();  
  });  
  });  
</script>


</body>
</html>
